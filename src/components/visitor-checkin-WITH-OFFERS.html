<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Check-in - With Offers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://n8n.tenear.com; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com;">
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-lg p-8 max-w-md w-full">
        <div id="loading" class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Loading...</h2>
            <p class="text-gray-600">Processing your check-in...</p>
        </div>

        <div id="checkin-form" class="hidden">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold text-gray-800 mb-2" id="checkin-title">QR Code Check-in</h1>
                <p class="text-gray-600" id="checkin-subtitle">Scan successful! Ready to check in?</p>
            </div>

            <div id="qr-data" class="space-y-4 mb-6">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <div>
                        <p class="text-sm text-gray-500">Campaign</p>
                        <p class="font-semibold" id="campaign-name">-</p>
                    </div>
                </div>

                <div class="p-4 bg-blue-500 text-white rounded-lg">
                    <p class="text-sm opacity-90">Location Zone</p>
                    <p class="text-xl font-bold" id="zone-name">-</p>
                    <p class="text-sm opacity-90" id="location-name">-</p>
                </div>
            </div>

            <div class="space-y-3">
                <button id="checkin-btn" onclick="handleCheckin()" 
                        class="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    Check In
                </button>
                <button onclick="window.location.reload()" 
                        class="w-full py-3 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Cancel
                </button>
            </div>

            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">
                    By checking in, you consent to track your visit for campaign analytics.
                </p>
            </div>
        </div>

        <div id="success" class="hidden text-center">
            <div class="text-green-500 text-6xl mb-4">‚úÖ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Check-in Successful!</h2>
            <p class="text-gray-600 mb-6" id="success-message">
                Welcome! You've successfully checked in
            </p>

            <!-- SPECIAL OFFER SECTION -->
            <div id="special-offer" class="mb-6">
                <div class="p-6 bg-gradient-to-r from-yellow-400 to-orange-500 text-white rounded-lg pulse">
                    <h3 class="text-2xl font-bold mb-2">üéâ Exclusive Offer!</h3>
                    <p class="text-lg mb-2" id="offer-text">15% OFF your next visit</p>
                    <p class="text-sm opacity-90" id="offer-details">Valid for 30 days ‚Ä¢ Any location</p>
                </div>
                
                <div class="mt-4 space-y-2">
                    <button id="claim-offer-btn" onclick="handleOfferClaim()" 
                            class="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold pulse">
                        üéÅ Claim This Offer
                    </button>
                </div>
            </div>

            <!-- LOYALTY PROGRAM SECTION -->
            <div id="loyalty-program" class="mb-6 hidden">
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h4 class="font-bold text-blue-800 mb-2">‚≠ê Join VIP Program</h4>
                    <p class="text-sm text-blue-600 mb-3">Get exclusive offers, early access to sales, and birthday rewards!</p>
                    <button onclick="handleLoyaltySignup()" 
                            class="w-full py-2 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-semibold">
                        Join Free Program
                    </button>
                </div>
            </div>

            <!-- ACTION BUTTONS -->
            <div class="space-y-3">
                <button onclick="closeWindow()" 
                        class="w-full py-3 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Continue Shopping
                </button>
                <button onclick="exploreOffers()" 
                        class="w-full py-2 px-4 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition-colors text-sm">
                    Explore More Offers
                </button>
            </div>

            <!-- PRIVACY NOTE -->
            <div class="mt-4 text-center">
                <p class="text-xs text-gray-400">
                    Your privacy is important to us. Offers are optional.
                </p>
            </div>
        </div>

        <div id="offer-claimed" class="hidden text-center">
            <div class="text-green-500 text-6xl mb-4">üéâ</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Offer Claimed!</h2>
            <div class="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                <p class="text-green-800 font-semibold" id="claimed-offer-text">15% OFF your next visit</p>
                <p class="text-sm text-green-600 mt-2" id="claimed-offer-details">Show this confirmation at checkout</p>
            </div>
            <button onclick="exploreOffers()" 
                    class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                Explore More Offers
            </button>
            <button onclick="closeWindow()" 
                    class="w-full mt-2 py-2 px-4 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                Close
            </button>
        </div>

        <div id="error" class="hidden text-center">
            <div class="text-red-500 text-6xl mb-4">‚ùå</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Check-in Failed</h2>
            <p class="text-gray-600 mb-6" id="error-message">
                Something went wrong. Please try again or contact support.
            </p>
            <button onclick="window.location.reload()" 
                    class="w-full py-3 px-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold">
                Try Again
            </button>
        </div>
    </div>

    <script>
        let checkinData = null;
        let hasClaimedOffer = false;

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                shopId: params.get('s') || '',
                visitorType: params.get('v') || '',
                campaign: params.get('c') || '',
                location: params.get('l') || '',
                zone: params.get('z') || '',
                type: params.get('t') || 'checkin'
            };
        }

        function getZoneName(zone) {
            const zoneMap = {
                'entrance': 'Mall Entrance',
                'checkout': 'Checkout Counter', 
                'display': 'Product Display'
            };
            return zoneMap[zone] || zone;
        }

        function getZoneColor(zone) {
            const colorMap = {
                'entrance': 'bg-green-500',
                'checkout': 'bg-blue-500',
                'display': 'bg-purple-500'
            };
            return colorMap[zone] || 'bg-gray-500';
        }

        function initializePage() {
            const data = getUrlParams();
            
            console.log('QR Code Data:', data);
            
            if (!data.campaign || !data.zone || !data.location) {
                showError('Invalid QR code. Please contact support if you continue to have issues.');
                return;
            }

            checkinData = data;
            
            // Update UI
            document.getElementById('campaign-name').textContent = data.campaign;
            document.getElementById('zone-name').textContent = getZoneName(data.zone);
            document.getElementById('location-name').textContent = data.location;
            
            const zoneColor = getZoneColor(data.zone);
            const zoneElement = document.querySelector('.bg-blue-500');
            zoneElement.className = `p-4 ${zoneColor} text-white rounded-lg`;
            
            if (data.type === 'claim') {
                document.getElementById('checkin-title').textContent = 'Offer Claim';
                document.getElementById('checkin-subtitle').textContent = 'Scan successful! Ready to claim your offer?';
                document.getElementById('checkin-btn').textContent = 'Claim Offer';
            }

            document.getElementById('loading').classList.add('hidden');
            document.getElementById('checkin-form').classList.remove('hidden');
        }

        async function handleCheckin() {
            if (!checkinData) return;
            
            const btn = document.getElementById('checkin-btn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            
            try {
                const webhookUrl = checkinData.type === 'claim' 
                    ? 'https://n8n.tenear.com/webhook/claim-offer'
                    : 'https://n8n.tenear.com/webhook/visitor-checkins';
                
                const payload = {
                    s: checkinData.shopId || '0',
                    v: checkinData.visitorType || 'unknown',
                    c: checkinData.campaign || 'default',
                    l: checkinData.location || 'unknown',
                    z: checkinData.zone || 'general',
                    t: checkinData.type || 'checkin',
                    timestamp: new Date().toISOString(),
                    source: 'qr_code_scan',
                    url: window.location.href,
                    user_agent: navigator.userAgent
                };
                
                const response = await fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Webhook response:', result);
                    
                    // Generate success message
                    const zoneName = getZoneName(checkinData.zone);
                    const locationName = checkinData.location;
                    let successText = `Welcome! You've successfully checked in at ${zoneName}`;
                    
                    if (locationName && locationName !== 'unknown') {
                        successText = `Welcome! You've successfully checked in at ${locationName}`;
                    }
                    
                    document.getElementById('success-message').textContent = successText;
                    
                    // Customize offer based on visitor type
                    let offerText = '15% OFF your next visit';
                    let offerDetails = 'Valid for 30 days ‚Ä¢ Any location';
                    
                    if (checkinData.visitorType === 'first_time_visitor') {
                        offerText = '20% OFF your first purchase';
                        offerDetails = 'Welcome offer ‚Ä¢ Use within 7 days';
                    } else if (checkinData.visitorType === 'loyal_customer') {
                        offerText = 'VIP 25% OFF exclusive deal';
                        offerDetails = 'Thank you for being loyal!';
                    }
                    
                    document.getElementById('offer-text').textContent = offerText;
                    document.getElementById('offer-details').textContent = offerDetails;
                    
                    // Show loyalty program for returning customers
                    if (checkinData.visitorType === 'regular_visitor' || checkinData.visitorType === 'unknown') {
                        document.getElementById('loyalty-program').classList.remove('hidden');
                    }
                    
                    document.getElementById('checkin-form').classList.add('hidden');
                    document.getElementById('success').classList.remove('hidden');
                } else {
                    const errorText = await response.text();
                    console.error('Webhook error:', errorText);
                    throw new Error(`Check-in failed (${response.status})`);
                }
            } catch (error) {
                console.error('Check-in error:', error);
                
                let errorMessage = 'Unable to process your check-in. Please try again or contact support.';
                
                if (error.message.includes('Network')) {
                    errorMessage = 'Network connection issue. Please check your internet and try again.';
                }
                
                document.getElementById('error-message').textContent = errorMessage;
                
                document.getElementById('checkin-form').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.textContent = checkinData.type === 'claim' ? 'Claim Offer' : 'Check In';
            }
        }

        async function handleOfferClaim() {
            if (hasClaimedOffer) return;
            
            const btn = document.getElementById('claim-offer-btn');
            btn.disabled = true;
            btn.textContent = 'Claiming...';
            
            hasClaimedOffer = true;
            
            try {
                // Send offer claim to webhook
                const payload = {
                    s: checkinData.shopId || '0',
                    v: checkinData.visitorType || 'unknown',
                    c: checkinData.campaign || 'offer_claim',
                    l: checkinData.location || 'unknown',
                    z: checkinData.zone || 'general',
                    t: 'claim',
                    offer_type: 'next_visit_discount',
                    discount_percent: checkinData.visitorType === 'first_time_visitor' ? 20 : 
                                    checkinData.visitorType === 'loyal_customer' ? 25 : 15,
                    claimed_at: new Date().toISOString(),
                    source: 'qr_success_offer'
                };
                
                const response = await fetch('https://n8n.tenear.com/webhook/claim-offer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    // Show claimed confirmation
                    const offerText = document.getElementById('offer-text').textContent;
                    const offerDetails = document.getElementById('offer-details').textContent;
                    
                    document.getElementById('claimed-offer-text').textContent = offerText;
                    document.getElementById('claimed-offer-details').textContent = offerDetails;
                    
                    document.getElementById('success').classList.add('hidden');
                    document.getElementById('offer-claimed').classList.remove('hidden');
                } else {
                    throw new Error('Failed to claim offer');
                }
            } catch (error) {
                alert('Unable to claim offer. Please try again or ask for assistance.');
                btn.disabled = false;
                btn.textContent = 'üéÅ Claim This Offer';
                hasClaimedOffer = false;
            }
        }

        function handleLoyaltySignup() {
            // This could trigger a loyalty signup flow
            alert('üéâ Welcome to our VIP program! Check your email for exclusive offers.');
        }

        function closeWindow() {
            // More robust window closing for different browser contexts
            try {
                if (window.opener) {
                    window.close();
                } else {
                    // If window wasn't opened by script, try to navigate back
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        // If no history, try to close (may not work in some browsers)
                        window.location.href = 'about:blank';
                    }
                }
            } catch (e) {
                // Fallback: change location to a blank page
                window.location.href = 'about:blank';
            }
        }

        function exploreOffers() {
            if (!checkinData) {
                alert('Please complete check-in first');
                return;
            }

            // FIXED: Use customer-facing domain instead of admin domain
            const customerDomain = 'https://tenearcheckins.pages.dev';
            const url = new URL('/visitor-offers-portal.html', customerDomain);
            
            // FIXED: Use correct property names from checkinData
            url.searchParams.set('mall_id', '3'); // Default to China Square Mall since we don't have mall_id in QR params
            url.searchParams.set('shop_id', checkinData.shopId || '3');
            url.searchParams.set('zone', checkinData.zone || 'general');
            url.searchParams.set('visitor_type', checkinData.visitorType || 'first_time_visitor');
            url.searchParams.set('timestamp', new Date().toISOString());

            console.log('üîó Opening customer portal:', url.toString());
            window.open(url.toString(), '_blank');
        }
        
        function showError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        window.addEventListener('load', initializePage);
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9a2980883fdcfa35","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"e72945439c264b3b85d2e3b689102d27"}' crossorigin="anonymous"></script>
</body>
</html>