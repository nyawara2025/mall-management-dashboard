import { User, AuthToken, Mall, Shop } from '../types/auth';

// Browser-compatible token generation
function generateSimpleToken(user: User): string {
  const timestamp = Date.now();
  const tokenData = `${user.id}-${user.username}-${user.role}-${user.mall_id || ''}-${user.shop_id || ''}-${timestamp}`;
  return btoa(tokenData); // Browser built-in Base64 encoding
}

// Real database users - PLACEHOLDER DATA, UPDATE WITH ACTUAL DATABASE IDs
// Run the SQL query to get actual user data:
// SELECT id, username, full_name, role, mall_id, shop_id, active FROM users ORDER BY id;
const REAL_USERS = new Map<string, { password_hash: string; user: User }>();

// Super Admin
REAL_USERS.set('bosco', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 100, // UPDATE WITH ACTUAL ID FROM DATABASE
    username: 'bosco', 
    full_name: 'Bosco Mukira',
    role: 'super_admin', 
    mall_id: null, 
    shop_id: null, 
    active: true 
  } 
});

// Mall Admins
REAL_USERS.set('jane', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 5, // UPDATE WITH ACTUAL ID FROM DATABASE
    username: 'jane', 
    full_name: 'Jane Mkenya',
    role: 'mall_admin', 
    mall_id: 3, // China Square Mall
    shop_id: null, 
    active: true 
  } 
});

REAL_USERS.set('faith', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 10, // UPDATE WITH ACTUAL ID FROM DATABASE
    username: 'faith', 
    full_name: 'Faith WaKenya',
    role: 'mall_admin', 
    mall_id: 6, // Langata Mall
    shop_id: null, 
    active: true 
  } 
});

REAL_USERS.set('ngina', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 11, // UPDATE WITH ACTUAL ID FROM DATABASE
    username: 'ngina', 
    full_name: 'Ngina Wanjiku',
    role: 'mall_admin', 
    mall_id: 7, // NHC Mall
    shop_id: null, 
    active: true 
  } 
});

// Shop Admins - Current
REAL_USERS.set('ben', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 6, // UPDATE WITH ACTUAL ID FROM DATABASE
    username: 'ben', 
    full_name: 'Ben Agina',
    role: 'shop_admin', 
    mall_id: 3, // China Square Mall
    shop_id: 3, // Spatial Barbershop
    active: true 
  } 
});

// Shop Admins - Missing Users (need to be added to database)
REAL_USERS.set('sandra', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 12, // TEMPORARY ID - will be assigned when added to database
    username: 'sandra', 
    full_name: 'Sandra Sawe',
    role: 'shop_admin', 
    mall_id: 6, // Langata Mall - UPDATE WITH ACTUAL ID (matching database)
    shop_id: 6, // Sandra's actual shop_id in database
    active: true 
  } 
});

REAL_USERS.set('andrew', { 
  password_hash: '$2b$10$demo123hashedpassword', 
  user: { 
    id: 13, // TEMPORARY ID - will be assigned when added to database
    username: 'andrew', 
    full_name: 'Andrew - The Phone Shop',
    role: 'shop_admin', 
    mall_id: 6, // Langata Mall
    shop_id: 7, // The Phone Shop
    active: true 
  } 
});

REAL_USERS.set('ibrahim', {
  password_hash: '$2b$10$demo123hashedpassword',
  user: {
   id: 15, 
   username: 'ibrahim',
   full_name: 'Ibrahim - Maliet Salon & Spa',
   role: 'shop_admin',
   mall_id: 7,
   shop_id: 9,
   active: true
 }
});

// FIXED: Real mall data with CORRECT mall_ids matching the database
// Run the SQL query to get actual mall data:
// SELECT id, name, latitude, longitude, address, radius_meters, active FROM malls ORDER BY id;
const REAL_MALLS: Mall[] = [
  {
    id: 3, // FIXED: China Square Mall - was 1, now 3
    name: 'China Square',
    latitude: -1.2921, // UPDATE WITH ACTUAL COORDINATES FROM DATABASE
    longitude: 36.8219,
    address: 'Langata, Nairobi', // UPDATE WITH ACTUAL ADDRESS FROM DATABASE
    radius_meters: 150.00, // UPDATE WITH ACTUAL RADIUS FROM DATABASE
    active: true,
    created_at: '2024-01-15T10:00:00Z', // UPDATE WITH ACTUAL TIMESTAMPS
    updated_at: '2024-01-15T10:00:00Z',
    shops: [
      { 
        id: 3, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'Spatial Barbershop', 
        created_at: '2024-01-15T10:00:00Z', 
        updated_at: '2024-01-15T10:00:00Z' 
      },
      { 
        id: 4, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'Mall Cafe', 
        created_at: '2024-01-15T11:00:00Z', 
        updated_at: '2024-01-15T11:00:00Z' 
      }
    ]
  },
  {
    id: 6, // FIXED: Langata Mall - was 2, now 6
    name: 'Langata Mall',
    latitude: -1.323957, // UPDATE WITH ACTUAL COORDINATES FROM DATABASE
    longitude: 36.782825,
    address: 'Langata, Nairobi', // UPDATE WITH ACTUAL ADDRESS FROM DATABASE
    radius_meters: 150.00, // UPDATE WITH ACTUAL RADIUS FROM DATABASE
    active: true,
    created_at: '2024-01-16T11:00:00Z',
    updated_at: '2024-01-16T11:00:00Z',
    shops: [
      { 
        id: 6, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'Kika Wines', 
        created_at: '2024-01-16T11:00:00Z', 
        updated_at: '2024-01-16T12:00:00Z' 
      },
      { 
        id: 7, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'The Phone Shop', 
        created_at: '2024-01-16T12:00:00Z', 
        updated_at: '2024-01-16T13:00:00Z' 
      },
      { 
        id: 8, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'CleanShelf SuperMarket', 
        created_at: '2024-01-16T13:00:00Z', 
        updated_at: '2024-01-16T14:00:00Z' 
      }
    ]
  },
  {
    id: 7, // NHC Mall - NEW ADDITION
    name: 'NHC Mall',
    latitude: -1.3, // UPDATE WITH ACTUAL COORDINATES FROM DATABASE
    longitude: 36.8, // UPDATE WITH ACTUAL COORDINATES FROM DATABASE
    address: 'Nairobi, Kenya', // UPDATE WITH ACTUAL ADDRESS FROM DATABASE
    radius_meters: 200.00, // UPDATE WITH ACTUAL RADIUS FROM DATABASE
    active: true,
    created_at: '2024-01-17T10:00:00Z', // UPDATE WITH ACTUAL TIMESTAMPS
    updated_at: '2024-01-17T10:00:00Z',
    shops: [
      { 
        id: 9, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'Maliet Salon & Spa', 
        created_at: '2024-01-17T10:00:00Z', 
        updated_at: '2024-01-17T11:00:00Z' 
      },
      { 
        id: 10, // UPDATE WITH ACTUAL SHOP ID FROM DATABASE
        name: 'Gravity CBC Resource Centre', 
        created_at: '2024-01-17T11:00:00Z', 
        updated_at: '2024-01-17T12:00:00Z' 
      },
      {
        id: 11, 
        name: 'Hydramist Drinking Water services',
        created_at: '2024-01-17T11:00:00Z',
        updated_at: '2024-01-17T12:00:00Z'
      }
    ]
  }
];

// Authentication Service
export class AuthService {
  private static readonly N8N_AUTH_URL = 'https://n8n.tenear.com/webhook/adgeologin';
  private static readonly LOCAL_FALLBACK = true; // Set to false when n8n is working

  static async login(username: string, password: string): Promise<{ success: boolean; user?: User; token?: string; error?: string }> {
    try {
      console.log('ðŸ” Attempting login for:', username);

      // Use n8n authentication
      const payload = { username, password };
      const response = await fetch(this.N8N_AUTH_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        console.error('âŒ n8n authentication failed:', response.status);
        return { success: false, error: `Authentication failed: ${response.status}` };
      }

      const result = await response.json();
      console.log('ðŸ” n8n response:', result);

      // Check if n8n returned a success field in the JSON
      if (result.success === false) {
        console.error('âŒ n8n authentication failed (business logic):', result.error);
        return { success: false, error: result.error || 'Authentication failed' };
      }

      console.log('âœ… Authentication successful via n8n:', result);

      // Convert n8n response to our User format
      // n8n returns: {id, username, full_name, role, mall_access[], shop_access[], success: true}
      // We need: {id, username, full_name, role, mall_id, shop_id, mall_access[], shop_access[]}
      const user: User = {
        id: result.id || result.user_id,
        username: result.username,
        full_name: result.full_name,
        role: result.role,
        mall_id: result.mall_access?.[0] || null,
        shop_id: result.shop_access?.[0] || null,
        mall_access: result.mall_access || [],
        shop_access: result.shop_access || [],
        active: true
      };

      // Store auth token and user data
      // Generate a simple token based on user data since n8n is handling the authentication
      const authToken = result.auth_token || result.token || 
        `${user.id}-${user.username}-${user.role}-${user.mall_id || 'none'}-${user.shop_id || 'none'}-${Date.now()}`;

      console.log('ðŸ” Generated auth token:', authToken.substring(0, 20) + '...');
      console.log('ðŸ” Token length:', authToken.length);
      console.log('ðŸ” Token data:', authToken);
      
      // Store in localStorage
      localStorage.setItem('geofence_auth_token', authToken);
      localStorage.setItem('geofence_user_data', JSON.stringify(user));
      
      console.log('ðŸ” Stored token in localStorage');
      console.log('ðŸ” Stored user data:', user);

      return {
        success: true,
        token: authToken,
        user: user
      };

    } catch (error) {
      console.error('âŒ Authentication error:', error);
      return { 
        success: false, 
        error: `Authentication failed: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static logout(): void {
    localStorage.removeItem('geofence_auth_token');
    localStorage.removeItem('geofence_user_data');
  }
  
  static verifyToken(token: string): AuthToken | null {
    try {
      // Decode the token format: userId-username-role-mallId-shopId-timestamp
      const decodedString = atob(token);
      const [userId, username, role, mallId, shopId, timestamp] = decodedString.split('-');
      
      // Basic validation
      if (!userId || !username || !role || !timestamp) return null;
      
      // Check if token is expired
      const tokenTime = parseInt(timestamp);
      const expirationTime = tokenTime + (24 * 60 * 60) * 1000; // 24 hours in milliseconds
      
      if (Date.now() > expirationTime) {
        return null; // Token expired
      }
      
      // Create AuthToken object
      return {
        username,
        role: role as 'super_admin' | 'mall_admin' | 'shop_admin',
        userId: parseInt(userId),
        mall_id: mallId ? parseInt(mallId) : null,
        shop_id: shopId ? parseInt(shopId) : null,
        exp: expirationTime
      };
    } catch (error) {
      return null;
    }
  }
  
  static isTokenValid(token: string): boolean {
    return this.verifyToken(token) !== null;
  }
  
  static decodeToken(token: string): AuthToken | null {
    try {
      const decodedString = atob(token);
      const [userId, username, role, mallId, shopId, timestamp] = decodedString.split('-');
      
      if (!userId || !username || !role || !timestamp) return null;
      
      return {
        username,
        role: role as 'super_admin' | 'mall_admin' | 'shop_admin',
        userId: parseInt(userId),
        mall_id: mallId ? parseInt(mallId) : null,
        shop_id: shopId ? parseInt(shopId) : null,
        exp: parseInt(timestamp) + (24 * 60 * 60) * 1000
      };
    } catch {
      return null;
    }
  }
  
  static getCurrentUser(): User | null {
    try {
      const userData = localStorage.getItem('geofence_user_data');
      if (userData) {
        return JSON.parse(userData);
      }
      return null;
    } catch {
      return null;
    }
  }
}

// API Service for Mall Management
export class MallApiService {
  private static readonly API_BASE_URL = 'https://n8n.tenear.com/webhook/management/malls';
  
  static async fetchMalls(token: string): Promise<{ success: boolean; data?: Mall[]; error?: string }> {
    try {
      console.log('ðŸª MallApiService: fetchMalls called');
      console.log('ðŸª Token received:', token ? `${token.substring(0, 20)}...` : 'EMPTY TOKEN');
      
      // Check if token exists
      if (!token || token.trim() === '') {
        console.error('ðŸª No token provided');
        return { success: false, error: 'No authentication token provided' };
      }
      
      console.log('ðŸª Making actual API call to n8n webhook...');
      
      // Make actual API call to n8n webhook instead of using local mock data
      const response = await fetch(this.API_BASE_URL, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        }
      });
      
      console.log('ðŸª n8n webhook response status:', response.status);
      
      if (!response.ok) {
        console.error('ðŸª n8n webhook call failed:', response.status, response.statusText);
        return { 
          success: false, 
          error: `API call failed: ${response.status} ${response.statusText}` 
        };
      }
      
      const responseData = await response.json();
      console.log('ðŸª n8n webhook response data:', responseData);
      
      // Handle different response formats
      let mallsData;
      if (Array.isArray(responseData)) {
        // Direct array response
        mallsData = responseData;
      } else if (responseData.data && Array.isArray(responseData.data)) {
        // Wrapped in data property
        mallsData = responseData.data;
      } else if (responseData.malls && Array.isArray(responseData.malls)) {
        // Wrapped in malls property
        mallsData = responseData.malls;
      } else {
        console.warn('ðŸª Unexpected response format from n8n:', responseData);
        return { 
          success: false, 
          error: 'Invalid response format from API' 
        };
      }
      
      console.log('ðŸª Extracted mall data:', mallsData.length, 'malls');
      
      // Transform n8n response to our Mall format
      const transformedMalls: Mall[] = mallsData.map((mall: any) => ({
        id: mall.id,
        name: mall.name,
        latitude: mall.latitude || -1.2921,
        longitude: mall.longitude || 36.8219,
        address: mall.address || 'Unknown Location',
        radius_meters: mall.radius_meters || 150.00,
        active: mall.active !== undefined ? mall.active : true,
        created_at: mall.created_at || new Date().toISOString(),
        updated_at: mall.updated_at || new Date().toISOString(),
        shops: Array.isArray(mall.shops) ? mall.shops : []
      }));
      
      console.log('ðŸª Transformed mall data:', transformedMalls.length, 'malls');
      console.log('ðŸª Mall names:', transformedMalls.map(m => m.name).join(', '));
      
      return { 
        success: true,
        data: transformedMalls
      };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static async fetchMallDetails(mallId: number, token: string): Promise<{ success: boolean; data?: Mall; error?: string }> {
    try {
      const mallsResponse = await this.fetchMalls(token);
      if (!mallsResponse.success || !mallsResponse.data) {
        return { success: false, error: 'Failed to fetch malls' };
      }
      
      const mall = mallsResponse.data.find(m => m.id === mallId);
      if (!mall) {
        return { success: false, error: 'Mall not found or access denied' };
      }
      
      return { success: true, data: mall };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  // CRITICAL FIX: This method now properly filters shops for shop admins
  static async fetchShops(mallId: number, token: string): Promise<{ success: boolean; data?: Shop[]; error?: string }> {
    try {
      const mallsResponse = await this.fetchMalls(token);
      if (!mallsResponse.success || !mallsResponse.data) {
        return { success: false, error: 'Failed to fetch malls' };
      }
      
      const mall = mallsResponse.data.find(m => m.id === mallId);
      if (!mall) {
        return { success: false, error: 'Mall not found or access denied' };
      }
      
      // Get all shops for this mall
      let shops = mall.shops || [];
      
      // CRITICAL FIX: For shop admins, only return their specific assigned shop
      const authToken = AuthService.decodeToken(token);
      if (authToken?.role === 'shop_admin' && authToken.shop_id) {
        // Shop admins can only see their own assigned shop
        shops = shops.filter(shop => shop.id === authToken.shop_id);
      }
      // Mall admins and super admins see all shops in the mall
      
      return { success: true, data: shops };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static async createMall(mallData: Partial<Mall>, token: string): Promise<{ success: boolean; data?: Mall; error?: string }> {
    try {
      await new Promise(resolve => setTimeout(resolve, 800));
      
      const newMall: Mall = {
        id: Math.max(...REAL_MALLS.map(m => m.id)) + 1,
        name: mallData.name || 'New Mall',
        latitude: mallData.latitude || -1.2921,
        longitude: mallData.longitude || 36.8219,
        address: mallData.address || 'Unknown Location',
        radius_meters: mallData.radius_meters || 500,
        active: mallData.active !== undefined ? mallData.active : true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        shops: []
      };
      
      return { success: true, data: newMall };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static async updateMall(mallId: number, mallData: Partial<Mall>, token: string): Promise<{ success: boolean; data?: Mall; error?: string }> {
    try {
      await new Promise(resolve => setTimeout(resolve, 800));
      
      const existingMall = REAL_MALLS.find(m => m.id === mallId);
      if (!existingMall) {
        return { success: false, error: 'Mall not found' };
      }
      
      const updatedMall: Mall = {
        ...existingMall,
        ...mallData,
        updated_at: new Date().toISOString()
      };
      
      return { success: true, data: updatedMall };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static async deleteMall(mallId: number, token: string): Promise<{ success: boolean; error?: string }> {
    try {
      await new Promise(resolve => setTimeout(resolve, 800));
      
      const existingMall = REAL_MALLS.find(m => m.id === mallId);
      if (!existingMall) {
        return { success: false, error: 'Mall not found' };
      }
      
      return { success: true };
    } catch (error) {
      return { 
        success: false, 
        error: `Network error: ${error instanceof Error ? error.message : 'Unknown error'}` 
      };
    }
  }
  
  static createAuthHeaders(token: string): HeadersInit {
    return {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json',
    };
  }
}

// Export service objects for easy importing
export const AuthServiceExports = {
  login: AuthService.login.bind(AuthService),
  logout: AuthService.logout.bind(AuthService),
  decodeToken: AuthService.decodeToken.bind(AuthService),
  verifyToken: AuthService.verifyToken.bind(AuthService),
  isTokenValid: AuthService.isTokenValid.bind(AuthService),
  getCurrentUser: AuthService.getCurrentUser.bind(AuthService)
};

export const MallApiServiceExports = {
  fetchMalls: MallApiService.fetchMalls.bind(MallApiService),
  fetchMallDetails: MallApiService.fetchMallDetails.bind(MallApiService),
  createMall: MallApiService.createMall.bind(MallApiService),
  updateMall: MallApiService.updateMall.bind(MallApiService),
  deleteMall: MallApiService.deleteMall.bind(MallApiService),
  fetchShops: MallApiService.fetchShops.bind(MallApiService),
  createAuthHeaders: MallApiService.createAuthHeaders.bind(MallApiService)
};

// Individual exports for easier importing
export const login = AuthService.login;
export const logout = AuthService.logout;
export const decodeToken = AuthService.decodeToken;
export const verifyToken = AuthService.verifyToken;
export const isTokenValid = AuthService.isTokenValid;
export const getCurrentUser = AuthService.getCurrentUser;

// Utility function for creating auth headers
export function createAuthHeaders(token: string): HeadersInit {
  return {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json',
  };
}

export const fetchMalls = MallApiService.fetchMalls;
export const fetchMallDetails = MallApiService.fetchMallDetails;
export const createMall = MallApiService.createMall;
export const updateMall = MallApiService.updateMall;
export const deleteMall = MallApiService.deleteMall;
export const fetchShops = MallApiService.fetchShops;
export const createAuthHeadersFromService = MallApiService.createAuthHeaders;
