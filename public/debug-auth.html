<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Token Debug Tool</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .section { 
            margin: 20px 0; 
            padding: 15px; 
            background: #f9f9f9; 
            border-radius: 5px; 
            border-left: 4px solid #007cba; 
        }
        .token { 
            font-family: monospace; 
            background: #e9ecef; 
            padding: 10px; 
            border-radius: 4px; 
            word-break: break-all; 
            margin: 10px 0; 
        }
        .error { 
            color: #dc3545; 
            font-weight: bold; 
        }
        .success { 
            color: #28a745; 
            font-weight: bold; 
        }
        button { 
            background: #007cba; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px; 
        }
        button:hover { 
            background: #005a87; 
        }
        pre { 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
            overflow: auto; 
            font-size: 12px; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Auth Token Debug Tool</h1>
        <p>This tool helps debug the authentication token generation and storage process.</p>
        
        <div class="section">
            <h2>üìä Current Local Storage Status</h2>
            <div id="storageStatus">Loading...</div>
        </div>

        <div class="section">
            <h2>üß™ Test Token Generation</h2>
            <p>Simulate the token generation process with sample user data:</p>
            <button onclick="testTokenGeneration()">Generate Test Token</button>
            <div id="testTokenResult"></div>
        </div>

        <div class="section">
            <h2>üîß Test API Call</h2>
            <p>Test if the Authorization header is properly sent to n8n webhook:</p>
            <button onclick="testApiCall()">Test n8n Webhook Call</button>
            <div id="apiTestResult"></div>
        </div>

        <div class="section">
            <h2>üóëÔ∏è Clear Storage</h2>
            <button onclick="clearStorage()" style="background: #dc3545;">Clear All localStorage</button>
            <button onclick="refreshStatus()" style="background: #28a745;">Refresh Status</button>
        </div>
    </div>

    <script>
        function refreshStatus() {
            const token = localStorage.getItem('geofence_auth_token');
            const userData = localStorage.getItem('geofence_user_data');
            const timestamp = localStorage.getItem('geofence_user_data_timestamp');
            
            let html = '';
            
            if (token) {
                html += `<div class="success">‚úÖ Token found:</div>`;
                html += `<div class="token">${token}</div>`;
                html += `<div>Token length: ${token.length}</div>`;
                html += `<div>Token format: ${token.includes('-') ? 'Dash-separated (‚úÖ)' : 'Other format (‚ùå)'}</div>`;
            } else {
                html += `<div class="error">‚ùå No token found in localStorage</div>`;
            }
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    html += `<div class="success">‚úÖ User data found:</div>`;
                    html += `<pre>${JSON.stringify(user, null, 2)}</pre>`;
                } catch (e) {
                    html += `<div class="error">‚ùå Invalid user data JSON</div>`;
                    html += `<div class="token">${userData}</div>`;
                }
            } else {
                html += `<div class="error">‚ùå No user data found in localStorage</div>`;
            }
            
            if (timestamp) {
                html += `<div class="success">‚úÖ Timestamp found: ${timestamp}</div>`;
            } else {
                html += `<div class="error">‚ùå No timestamp found</div>`;
            }
            
            document.getElementById('storageStatus').innerHTML = html;
        }

        function testTokenGeneration() {
            // Test with the sample user data from n8n
            const sampleUserData = {
                id: 15,
                username: 'ibrahim',
                full_name: 'Ibrahim - Maliet Salon & Spa',
                role: 'shop_admin',
                mall_id: null, // This will be undefined in n8n response
                shop_id: null, // This will be undefined in n8n response
                mall_access: [7],
                shop_access: [9],
                active: true
            };
            
            console.log('üîç Testing token generation with sample user data:', sampleUserData);
            
            // Simulate the token generation from auth.ts
            const timestamp = Date.now();
            const mallId = sampleUserData.mall_id || sampleUserData.mall_access?.[0] || 0;
            const shopId = sampleUserData.shop_id || sampleUserData.shop_access?.[0] || 0;
            const token = `${sampleUserData.id}-${sampleUserData.username}-${sampleUserData.role}-${mallId}-${shopId}-${timestamp}`;
            
            console.log('üéØ Generated token:', token);
            
            let html = `<div class="success">‚úÖ Token generated successfully:</div>`;
            html += `<div class="token">${token}</div>`;
            html += `<div>Components:</div>`;
            html += `<pre>user.id: ${sampleUserData.id}
user.username: ${sampleUserData.username}
user.role: ${sampleUserData.role}
mallId: ${mallId} (from mall_access[0])
shopId: ${shopId} (from shop_access[0])
timestamp: ${timestamp}</pre>`;
            
            document.getElementById('testTokenResult').innerHTML = html;
        }

        async function testApiCall() {
            const authToken = localStorage.getItem('geofence_auth_token');
            const resultDiv = document.getElementById('apiTestResult');
            
            if (!authToken) {
                resultDiv.innerHTML = '<div class="error">‚ùå No token found in localStorage. Please log in first.</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div>üîÑ Making test API call...</div>';
            
            try {
                console.log('üß™ Testing API call with token:', authToken);
                
                const response = await fetch('https://n8n.tenear.com/webhook/management/malls', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                
                let html = `<div class="${response.ok ? 'success' : 'error'}">`;
                html += `${response.ok ? '‚úÖ' : '‚ùå'} Response: ${response.status}</div>`;
                html += `<div class="token">Response: ${responseText}</div>`;
                
                // Check if Authorization header was sent
                if (responseText.includes('No authorization header found')) {
                    html += '<div class="error">‚ùå Authorization header was NOT sent properly</div>';
                } else {
                    html += '<div class="success">‚úÖ Authorization header was sent successfully</div>';
                }
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                console.error('‚ùå API test error:', error);
                resultDiv.innerHTML = `<div class="error">‚ùå API call failed: ${error.message}</div>`;
            }
        }

        function clearStorage() {
            localStorage.removeItem('geofence_auth_token');
            localStorage.removeItem('geofence_user_data');
            localStorage.removeItem('geofence_user_data_timestamp');
            localStorage.removeItem('current_mall_id');
            document.getElementById('storageStatus').innerHTML = '<div class="success">‚úÖ localStorage cleared</div>';
        }

        // Load status on page load
        refreshStatus();
        
        // Auto-refresh status every 2 seconds to catch token updates
        setInterval(refreshStatus, 2000);
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"99d4fd9bb8936853","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"e72945439c264b3b85d2e3b689102d27"}' crossorigin="anonymous"></script>
</body>
</html>