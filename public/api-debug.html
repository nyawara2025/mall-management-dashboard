<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tool</title>
    <style>
        body { 
            font-family: monospace; 
            margin: 20px; 
            background: #1a1a1a; 
            color: #00ff00; 
            overflow-x: hidden; 
        }
        .container { 
            max-width: 100%; 
            margin: 0; 
            background: #000; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .log-entry { 
            margin: 5px 0; 
            padding: 5px; 
            background: #1a1a1a; 
            border-left: 3px solid #00ff00; 
            font-size: 12px; 
        }
        .error { 
            color: #ff0000; 
            border-left-color: #ff0000; 
        }
        .api-call { 
            color: #ffff00; 
            border-left-color: #ffff00; 
        }
        .response { 
            color: #00ffff; 
            border-left-color: #00ffff; 
        }
        .timestamp { 
            color: #888; 
            font-size: 10px; 
        }
        button { 
            background: #00ff00; 
            color: #000; 
            border: none; 
            padding: 8px 16px; 
            border-radius: 3px; 
            cursor: pointer; 
            font-family: monospace; 
            margin: 2px; 
        }
        .clear-btn { 
            background: #ff0000; 
            color: #fff; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¥ API DEBUG CONSOLE</h1>
        <button class="clear-btn" onclick="clearLogs()">CLEAR LOGS</button>
        <button onclick="testAuthHeader()">TEST AUTH HEADER</button>
        <div id="logs"></div>
    </div>

    <script>
        function log(message, type = 'log') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toISOString().split('T')[1].replace('Z', '');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `<span class="timestamp">[${timestamp}]</span> ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Override fetch to intercept all API calls
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const [url, options = {}] = args;
            
            log(`üöÄ FETCH CALLED: ${url}`, 'api-call');
            log(`üìã OPTIONS: ${JSON.stringify(options, null, 2)}`, 'api-call');
            
            // Check for Authorization header
            if (options.headers) {
                if (typeof options.headers === 'object') {
                    const authHeader = options.headers.Authorization || options.headers.authorization;
                    if (authHeader) {
                        log(`üîë AUTH HEADER FOUND: ${authHeader}`, 'log');
                    } else {
                        log(`‚ùå NO AUTH HEADER IN HEADERS OBJECT`, 'error');
                    }
                } else if (typeof options.headers === 'string') {
                    log(`üìù HEADERS (STRING): ${options.headers}`, 'log');
                    if (options.headers.includes('Authorization') || options.headers.includes('authorization')) {
                        log(`‚úÖ AUTH HEADER FOUND IN STRING HEADERS`, 'log');
                    } else {
                        log(`‚ùå NO AUTH HEADER IN STRING HEADERS`, 'error');
                    }
                }
            } else {
                log(`‚ùå NO HEADERS PROPERTY IN OPTIONS`, 'error');
            }

            try {
                const response = await originalFetch(...args);
                const responseClone = response.clone();
                const responseText = await responseClone.text();
                
                log(`‚úÖ RESPONSE STATUS: ${response.status}`, 'response');
                log(`üìÑ RESPONSE: ${responseText}`, 'response');
                
                return response;
            } catch (error) {
                log(`‚ùå FETCH ERROR: ${error.message}`, 'error');
                throw error;
            }
        };

        // Monitor localStorage changes
        function monitorLocalStorage() {
            const currentKeys = Object.keys(localStorage);
            const authToken = localStorage.getItem('geofence_auth_token');
            const userData = localStorage.getItem('geofence_user_data');
            
            if (authToken) {
                log(`üîë TOKEN: ${authToken}`, 'log');
            }
            
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    log(`üë§ USER: ${JSON.stringify(user)}`, 'log');
                } catch (e) {
                    log(`‚ùå INVALID USER JSON: ${userData}`, 'error');
                }
            }
        }

        // Test Authorization Header function
        async function testAuthHeader() {
            const authToken = localStorage.getItem('geofence_auth_token');
            
            if (!authToken) {
                log(`‚ùå NO TOKEN FOUND - LOGIN FIRST`, 'error');
                return;
            }
            
            log(`üß™ TESTING API CALL...`, 'log');
            
            try {
                const response = await fetch('https://n8n.tenear.com/webhook/management/malls', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const responseText = await response.text();
                log(`üìä TEST RESULT: ${response.status}`, 'response');
                log(`üìÑ RESPONSE BODY: ${responseText}`, 'response');
                
                if (responseText.includes('No authorization header found')) {
                    log(`‚ùå AUTH HEADER NOT SENT TO SERVER`, 'error');
                } else {
                    log(`‚úÖ AUTH HEADER SENT SUCCESSFULLY`, 'log');
                }
                
            } catch (error) {
                log(`‚ùå TEST FAILED: ${error.message}`, 'error');
            }
        }

        // Start monitoring
        log(`üîç API DEBUG CONSOLE STARTED`, 'log');
        monitorLocalStorage();
        
        // Check localStorage every 2 seconds
        setInterval(monitorLocalStorage, 2000);
        
        // Monitor localStorage changes
        window.addEventListener('storage', function(e) {
            log(`üìù LOCALSTORAGE CHANGED: ${e.key} = ${e.newValue}`, 'log');
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"99d54c554a7b23c9","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.9.1","token":"e72945439c264b3b85d2e3b689102d27"}' crossorigin="anonymous"></script>
</body>
</html>